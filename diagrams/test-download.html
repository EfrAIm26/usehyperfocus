<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Descarga PNG</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .download-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #667eea;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .download-btn:hover {
            transform: translateY(-2px);
        }
        .diagram-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <button class="download-btn" onclick="downloadDiagram()">üì• Descargar PNG</button>
    
    <div class="diagram-container">
        <svg id="diagramCanvas" viewBox="0 0 500 300" xmlns="http://www.w3.org/2000/svg">
            <rect x="50" y="50" width="400" height="200" fill="#e8f4f8" stroke="#0066cc" stroke-width="2" rx="8"/>
            <text x="250" y="90" text-anchor="middle" font-size="20" fill="#0066cc" font-weight="bold">Test Diagrama</text>
            <ellipse cx="250" cy="150" rx="80" ry="30" fill="white" stroke="#333" stroke-width="2"/>
            <text x="250" y="157" text-anchor="middle" font-size="14">Caso de Uso</text>
            <circle cx="100" cy="150" r="30" fill="none" stroke="#333" stroke-width="2"/>
            <line x1="100" y1="120" x2="100" y2="180" stroke="#333" stroke-width="2"/>
            <text x="100" y="210" text-anchor="middle" font-size="12" font-weight="bold">Actor</text>
            <line x1="130" y1="150" x2="170" y2="150" stroke="#333" stroke-width="2"/>
        </svg>
    </div>
    
    <script>
        function downloadDiagram() {
            const svgElement = document.getElementById('diagramCanvas');
            const btn = document.querySelector('.download-btn');
            const originalText = btn.innerHTML;
            
            console.log('üöÄ Iniciando descarga...');
            btn.innerHTML = '‚è≥ Generando...';
            btn.disabled = true;
            
            try {
                // Obtener SVG como string
                const svgData = new XMLSerializer().serializeToString(svgElement);
                console.log('‚úÖ SVG serializado');
                
                // Obtener dimensiones
                const viewBox = svgElement.getAttribute('viewBox').split(' ');
                const width = parseFloat(viewBox[2]);
                const height = parseFloat(viewBox[3]);
                console.log('üìê Dimensiones:', width, 'x', height);
                
                // Crear canvas
                const scale = 3;
                const canvas = document.createElement('canvas');
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext('2d');
                
                // Fondo blanco
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                console.log('‚úÖ Canvas creado');
                
                // Crear blob del SVG
                const svgWithNamespace = svgData.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                const svgBlob = new Blob([svgWithNamespace], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                console.log('‚úÖ Blob URL creado:', url);
                
                // Cargar imagen
                const img = new Image();
                
                img.onload = function() {
                    console.log('‚úÖ Imagen cargada');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    
                    // Convertir canvas a blob
                    canvas.toBlob(function(blob) {
                        console.log('‚úÖ PNG blob creado:', blob.size, 'bytes');
                        
                        // Crear descarga
                        const link = document.createElement('a');
                        link.download = 'test-diagrama-hyperfocus-ai.png';
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        
                        console.log('‚úÖ Descarga iniciada');
                        btn.innerHTML = '‚úÖ ¬°Descargado!';
                        btn.disabled = false;
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2500);
                    }, 'image/png', 1.0);
                };
                
                img.onerror = function(err) {
                    console.error('‚ùå Error cargando imagen:', err);
                    btn.innerHTML = '‚ùå Error';
                    btn.disabled = false;
                    alert('Error al generar PNG');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2500);
                };
                
                img.src = url;
                
            } catch (error) {
                console.error('‚ùå Error general:', error);
                btn.innerHTML = '‚ùå Error';
                btn.disabled = false;
                alert('Error: ' + error.message);
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2500);
            }
        }
    </script>
</body>
</html>





